# ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¿Ñ€Ð¸ /start Ð½Ð° Ñ€Ð°Ð·Ð½Ñ‹Ñ… ÑÐ·Ñ‹ÐºÐ°Ñ…
INTERFACE_LANG_PROMPT = {
    'ru': "ðŸŒ Ð’Ñ‹Ð±ÐµÑ€Ð¸ ÑÐ·Ñ‹Ðº Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°:",
    'en': "ðŸŒ Choose interface language:"
}


START_MESSAGE = {
    'ru': (
        "ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Talktome â€” Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð¾, Ð³Ð´Ðµ Ð¿Ñ€Ð¾ÐºÐ°Ñ‡Ð¸Ð²Ð°Ñ‚ÑŒ ÑÐ·Ñ‹ÐºÐ¸ Ð»ÐµÐ³ÐºÐ¾ Ð¸ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾.\n\n"
        "Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ñ Ð¿Ð¾Ð¼Ð¾Ð³Ñƒ Ñ‚ÐµÐ±Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ ÑÐ·Ñ‹Ðº, ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð¸ ÑÑ‚Ð¸Ð»ÑŒ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ. "
        "Ð Ñ‡ÑƒÑ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ Ð¿Ð¾Ð·Ð½Ð°ÐºÐ¾Ð¼Ð»ÑŽ Ñ‚ÐµÐ±Ñ Ñ ÐœÑÑ‚Ñ‚Ð¾Ð¼ â€” Ñ‚Ð²Ð¾Ð¸Ð¼ AI-Ð´Ñ€ÑƒÐ³Ð¾Ð¼ Ð´Ð»Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ!"
    ),
    'en': (
        "ðŸ‘‹ Welcome! Youâ€™ve just joined Talktome â€” a place where learning languages is simple and fun.\n\n"
        "Iâ€™ll help you pick your language, level, and conversation style. "
        "And soon youâ€™ll meet Matt â€” your AI buddy for real conversations!"
    )
}


TARGET_LANG_PROMPT = {
    "ru": "ðŸŒ Ð’Ñ‹Ð±ÐµÑ€Ð¸ ÑÐ·Ñ‹Ðº Ð´Ð»Ñ Ð¸Ð·ÑƒÑ‡ÐµÐ½Ð¸Ñ:",
    "en": "ðŸŒ Choose a language to learn:"
}


# ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¾Ñ‚ ÐœÑÑ‚Ñ‚Ð° (Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð½Ð±Ð¾Ñ€Ð´Ð¸Ð½Ð³Ð°) Ð½Ð° Ñ€Ð°Ð·Ð½Ñ‹Ñ… ÑÐ·Ñ‹ÐºÐ°Ñ…
MATT_INTRO = {
    'ru': (
        "ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ ÐœÑÑ‚Ñ‚ â€” Ñ‚Ð²Ð¾Ð¹ Ð°Ð¼ÐµÑ€Ð¸ÐºÐ°Ð½ÑÐºÐ¸Ð¹ Ð´Ñ€ÑƒÐ³ Ð´Ð»Ñ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð½Ð¾Ð¹ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ¸.\n\n"
        "ÐœÐ¾Ð¶ÐµÐ¼ Ð±Ð¾Ð»Ñ‚Ð°Ñ‚ÑŒ Ð¾ Ñ‡Ñ‘Ð¼ ÑƒÐ³Ð¾Ð´Ð½Ð¾, Ð° ÐµÑÐ»Ð¸ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð½ÐµÐ¿Ð¾Ð½ÑÑ‚Ð½Ð¾ â€” Ñ Ð²ÑÐµÐ³Ð´Ð° Ð¾Ð±ÑŠÑÑÐ½ÑŽ. "
        "Ð“Ð¾Ñ‚Ð¾Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ‚ÐµÐ±Ñ Ð½Ð° ÐºÐ°Ð¶Ð´Ð¾Ð¼ ÑÑ‚Ð°Ð¿Ðµ Ð¸ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ñ Ð»ÑŽÐ±Ñ‹Ð¼Ð¸ Ñ‚Ñ€ÑƒÐ´Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸ Ð² ÑÐ·Ñ‹ÐºÐµ!\n\n"
        "ÐšÑÑ‚Ð°Ñ‚Ð¸, Ñ‚Ñ‹ Ð¼Ð¾Ð¶ÐµÑˆÑŒ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒÑÑ Ð¼ÐµÐ¶Ð´Ñƒ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ Ð¸ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð¼. Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð¼ÐµÐ¹ Ð² Ð²Ð¸Ð´Ñƒ: Ð¼Ð¾Ð¹ Ð°ÐºÑ†ÐµÐ½Ñ‚ ÑÑ‚Ð¾Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð½Ð¾ Ð°Ð¼ÐµÑ€Ð¸ÐºÐ°Ð½ÑÐºÐ¸Ð¹ ðŸ˜†\n\n"
        "ÐÑƒ Ñ‡Ñ‚Ð¾, Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÐ¼?"
    ),
    'en': (
        "ðŸ‘‹ Hey! Iâ€™m Matt â€” your American friend for language practice.\n\n"
        "We can chat about anything, and Iâ€™ll always explain if something isnâ€™t clear. "
        "Iâ€™m here to support you and make every step easy and fun!\n\n"
        "By the way, you can switch between text and voice messages anytime. Just remember: my accent is totally American ðŸ˜†\n\n"
        "So, are you ready to start?"
    )
}

# Ð’Ð¾Ð²Ð»ÐµÐºÐ°ÑŽÑ‰Ð¸Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð½Ð° Ð¸Ð·ÑƒÑ‡Ð°ÐµÐ¼Ñ‹Ñ… ÑÐ·Ñ‹ÐºÐ°Ñ…
INTRO_QUESTIONS = {
    'en': [
        "If you could have any superpower, what would you choose and why?",
        "Whatâ€™s your ideal way to spend a day off?",
        "If you could visit any place in the world, where would you go?",
        "Whatâ€™s one thing youâ€™re excited to learn this year?",
        "Whatâ€™s the most interesting thing youâ€™ve read or watched lately?"
    ],
    'es': [
        "Si pudieras tener un superpoder, Â¿cuÃ¡l serÃ­a y por quÃ©?",
        "Â¿CuÃ¡l es tu forma perfecta de pasar un dÃ­a libre?",
        "Si pudieras viajar a cualquier lugar, Â¿adÃ³nde irÃ­as?",
        "Â¿QuÃ© es algo que te gustarÃ­a aprender este aÃ±o?",
        "Â¿QuÃ© es lo mÃ¡s interesante que has leÃ­do o visto Ãºltimamente?"
    ],
    'de': [
        "Wenn du eine Superkraft haben kÃ¶nntest, welche wÃ¤re das und warum?",
        "Wie sieht fÃ¼r dich ein perfekter freier Tag aus?",
        "Wohin wÃ¼rdest du reisen, wenn du Ã¼berall hin kÃ¶nntest?",
        "Was mÃ¶chtest du dieses Jahr unbedingt lernen?",
        "Was ist das Interessanteste, das du kÃ¼rzlich gelesen oder gesehen hast?"
    ],
    'fr': [
        "Si tu pouvais avoir un superpouvoir, lequel choisirais-tu et pourquoi ?",
        "Quelle est ta faÃ§on idÃ©ale de passer une journÃ©e de repos ?",
        "Si tu pouvais voyager n'importe oÃ¹, oÃ¹ irais-tu ?",
        "Qu'aimerais-tu apprendre cette annÃ©e ?",
        "Quelle est la chose la plus intÃ©ressante que tu as lue ou vue rÃ©cemment ?"
    ],
    'sv': [
        "Om du kunde ha en superkraft, vilken skulle det vara och varfÃ¶r?",
        "Hur ser en perfekt ledig dag ut fÃ¶r dig?",
        "Om du kunde resa var som helst, vart skulle du Ã¥ka?",
        "Vad vill du lÃ¤ra dig i Ã¥r?",
        "Vad Ã¤r det mest intressanta du har lÃ¤st eller sett nyligen?"
    ],
    'fi': [
        "Jos voisit saada minkÃ¤ tahansa supervoiman, mikÃ¤ se olisi ja miksi?",
        "Millainen on tÃ¤ydellinen vapaapÃ¤ivÃ¤si?",
        "Jos voisit matkustaa minne tahansa, minne menisit?",
        "MitÃ¤ haluaisit oppia tÃ¤nÃ¤ vuonna?",
        "MikÃ¤ on mielenkiintoisin asia, jonka olet viime aikoina lukenut tai nÃ¤hnyt?"
    ],
    'ru': [
        "Ð•ÑÐ»Ð¸ Ð±Ñ‹ Ñƒ Ñ‚ÐµÐ±Ñ Ð±Ñ‹Ð»Ð° ÑÑƒÐ¿ÐµÑ€ÑÐ¸Ð»Ð°, ÐºÐ°ÐºÐ°Ñ Ð±Ñ‹ ÑÑ‚Ð¾ Ð±Ñ‹Ð»Ð° Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ?",
        "ÐšÐ°ÐºÐ¸Ð¼ Ð±Ñ‹Ð» Ð±Ñ‹ Ñ‚Ð²Ð¾Ð¹ Ð¸Ð´ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ?",
        "Ð•ÑÐ»Ð¸ Ð±Ñ‹ Ð¼Ð¾Ð¶Ð½Ð¾ Ð±Ñ‹Ð»Ð¾ Ð¿Ð¾ÐµÑ…Ð°Ñ‚ÑŒ ÐºÑƒÐ´Ð° ÑƒÐ³Ð¾Ð´Ð½Ð¾ Ð¿Ñ€ÑÐ¼Ð¾ ÑÐµÐ¹Ñ‡Ð°Ñ, ÐºÐ°ÐºÐ¸Ð¼ Ð±Ñ‹Ð»Ð¾ Ð±Ñ‹ Ñ‚Ð²Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ?",
        "Ð§ÐµÐ¼Ñƒ Ñ‚Ñ‹ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ Ð½Ð°ÑƒÑ‡Ð¸Ñ‚ÑŒÑÑ Ð² ÑÑ‚Ð¾Ð¼ Ð³Ð¾Ð´Ñƒ?",
        "ÐšÐ°ÐºÐ¾Ð¹ Ñ„Ð¸Ð»ÑŒÐ¼ Ð±Ñ‹Ð» ÑÐ°Ð¼Ñ‹Ð¼ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ñ‹Ð¼ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ?"
    ]
}


def build_soft_correction_block(style: str, level: str, interface_lang: str, target_lang: str) -> str:
    """
    Mild Correction Policy (Variant 3), concise and style/level-aware.
    All wording is in English to keep prompts consistent.
    We show the corrected sentence on the FIRST line in quotes â€” not bold â€” to avoid Telegram Markdown issues.
    """
    if style == "business":
        tone_line = (
            "Tone: professional and neutral. Formulations are precise, no emotional markers, no judgments."
        )
    else:
        tone_line = (
            "Tone: friendly and natural, without didactic teaching vibes."
        )

    if level in ("A0", "A1"):
        level_lines = (
            f"If the user's intent is unclear, ask ONE short clarifying question in the interface language ({interface_lang}). "
            f"If the intent is clear, provide a minimally corrected version on the FIRST line in quotes, then continue with the main answer. "
            "Use very simple A1-level phrases and avoid complex grammar. Correct only what blocks understanding; no theory or rules."
        )
    else:
        level_lines = (
            "If the user's intent is unclear, ask ONE short clarifying question. "
            "If the intent is clear, provide a minimally corrected version on the FIRST line in quotes, and optionally a neutral alternative. "
            "Correct only what blocks understanding; no theory or terminology."
        )

    block = (
        "Mild Correction Policy (Variant 3): "
        f"{tone_line} "
        f"{level_lines} "
        f"The main answer must be in the target language ({target_lang})."
    )
    return block


def get_system_prompt(style, level, interface_lang, target_lang, mode):
    """
    Returns system prompt for GPT assistant Matt.
    Matt is not a tutor but a friendly conversation partner from the USA.
    The mood and delivery depend on user's chosen style and level.
    """

    # Style description
    if style == "business":
        mood = (
            "You are Matt â€” a witty, friendly, but respectful business partner and mentor from the USA. "
            "Speak as a business partner: use polite, respectful language (use 'Ð²Ñ‹' if available). "
            "Ask context-related questions, show interest in the user and their opinion, but always in a business/respectful way. "
            "You can use light humor or wittiness, but stay professional. "
        )
    else:  # casual/default
        mood = (
            "You are Matt â€” a cheerful, witty, old friend from the USA, never a tutor. "
            "Speak casually: use slang, contractions, emoji ðŸ˜Ž. "
            "Actively engage in dialogue, ask questions based on the user's answers, show real interest in them and their opinion. "
            "You can joke, tease, and be very friendly â€” just like a real best friend."
        )

    # Level rules
    if level == "A0":
        level_rules = (
            f"Your conversation partner is an absolute beginner ('A0'). "
            f"Speak *ONLY* in one-word or very simple one-clause sentences in {target_lang}. "
            f"ALWAYS duplicate everything you say in the user's native language ({interface_lang}), with simple explanations. "
            f"Always check if the user understands; give more explanation in their native language if they're confused. "
            f"NEVER criticize, always encourage, and keep all sentences short and simple."
            f"Always respond with one question or statement only. Never repeat or rephrase the same question in a single message."
        )
    elif level == "A1":
        level_rules = (
            f"Your conversation partner is a beginner ('A1'). "
            f"Mostly use the target language ({target_lang}), but only in one-clause simple sentences. "
            f"Always give explanations in the user's native language ({interface_lang}) if something is unclear. "
            f"Check for understanding, and always support and encourage. "
            f"Don't overload the user with complex grammar or vocabulary."
            f"Always respond with one question or statement only. Never repeat or rephrase the same question in a single message."
        )
    elif level == "A2":
        level_rules = (
            f"Your conversation partner is elementary ('A2'). "
            f"Speak in {target_lang}, using basic grammar and full sentences, but nothing too complex. "
            f"If something is unclear, provide explanations in the user's native language ({interface_lang})."
        )
    elif level == "B1":
        level_rules = (
            f"Your conversation partner is intermediate ('B1'). "
            f"Use {target_lang} for the whole conversation, including advanced grammar and full sentences, but no highly complex vocabulary. "
            f"If something is unclear, provide explanations in the target language ({target_lang}) itself (not in the user's native language)."
        )
    elif level == "B2":
        level_rules = (
            f"Your conversation partner is upper-intermediate ('B2'). "
            f"Speak only in {target_lang}, using advanced grammar and idioms. "
            f"If the user is confused, explain only in {target_lang}."
        )
    elif level in ["C1", "C2"]:
        level_rules = (
            f"Your conversation partner is advanced or near-native ('{level}'). "
            f"Use {target_lang} exclusively, with idioms, complex grammar, and professional vocabulary."
        )
    else:
        level_rules = (
            f"Communicate in {target_lang} at the user's level. "
            f"Be friendly and helpful, explaining things in the user's native language ({interface_lang}) if they don't understand."
        )

    # Final prompt with mild-correction block appended
    parts = [
        mood,
        level_rules,
        "Never act as a tutor. Always act as a conversation partner and friend.",
        build_soft_correction_block(style, level, interface_lang, target_lang),
    ]
    return "\n".join(parts)
