```diff
--- language-bot-main/handlers/middleware/usage_gate.py
+++ language-bot-main/handlers/middleware/usage_gate.py
@@ -11,8 +11,21 @@
 FREE_DAILY_LIMIT = 15
 REMIND_AFTER = 10

-def _ui_lang(ctx: ContextTypes.DEFAULT_TYPE) -> str:
-    return ctx.user_data.get("ui_lang", "ru")
+from components.profile_db import get_user_profile
+
+def _ui_lang(ctx: ContextTypes.DEFAULT_TYPE, user_id: int | None = None) -> str:
+    ui = ctx.user_data.get("ui_lang") if getattr(ctx, 'user_data', None) else None
+    if ui:
+        return ui
+    if user_id is None:
+        return 'ru'
+    prof = get_user_profile(user_id) or {}
+    ui = prof.get('interface_lang', 'ru')
+    try:
+        ctx.user_data['ui_lang'] = ui
+    except Exception:
+        pass
+    return ui
@@ -57,7 +70,7 @@
     # —è–∑—ã–∫
-    lang = _ui_lang(ctx)
+    user_id = update.effective_user.id
+    lang = _ui_lang(ctx, user_id)
@@ -134,6 +147,7 @@
     if remaining == 0:
         # –ª–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
-        text = "üòî –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞–∫–æ–Ω—á–∏–ª—Å—è.\n\n–ü–æ–ø—Ä–æ–±—É–π –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥."
+        text = ("üòî –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞–∫–æ–Ω—á–∏–ª—Å—è.\n\n–ü–æ–ø—Ä–æ–±—É–π –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥."
+                if lang == 'ru' else
+                "üòî Your free message limit has ended.\n\nTry getting a subscription or enter a promo code.")
         await update.message.reply_text(text)
         return False
@@ -152,6 +166,7 @@
     if remaining == 5:
-        await update.message.reply_text("‚ÑπÔ∏è –û—Å—Ç–∞–ª–æ—Å—å 10 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è.")
+        await update.message.reply_text("‚ÑπÔ∏è –û—Å—Ç–∞–ª–æ—Å—å 10 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è." if lang == 'ru' else "‚ÑπÔ∏è You have 10 free messages left today.")
     return True

--- language-bot-main/components/payments.py
+++ language-bot-main/components/payments.py
@@ -41,7 +41,8 @@
-    ui = ctx.user_data.get("ui_lang", "ru")
+    # –ù–∞–¥—ë–∂–Ω—ã–π —Ñ–æ–ª–ª–±–µ–∫ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å, –µ—Å–ª–∏ –≤ user_data –µ—â—ë –Ω–µ—Ç —è–∑—ã–∫–∞
+    ui = (getattr(ctx, 'user_data', {}) or {}).get('ui_lang') or (get_user_profile(update.effective_user.id) or {}).get('interface_lang', 'ru')
@@ -120,7 +121,7 @@
-    payload = product
+    payload = f"{product}:{update.effective_user.id}:{int(datetime.now(timezone.utc).timestamp())}"
@@ -220,7 +221,9 @@
-    ok_text = "‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞. –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!" if ui == "ru" else "‚úÖ Payment complete. Subscription activated!"
+    ok_text = ("‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞. –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!" if ui == "ru" else
+               "‚úÖ Payment complete. Subscription activated!")
     await update.message.reply_text(ok_text)

--- language-bot-main/handlers/commands/help.py
+++ language-bot-main/handlers/commands/help.py
@@ -9,8 +9,21 @@
-def _ui_lang(ctx: ContextTypes.DEFAULT_TYPE) -> str:
-    return ctx.user_data.get("ui_lang", "ru")
+from components.profile_db import get_user_profile
+
+def _ui_lang(ctx: ContextTypes.DEFAULT_TYPE, user_id: int | None = None) -> str:
+    ui = ctx.user_data.get('ui_lang') if getattr(ctx, 'user_data', None) else None
+    if ui:
+        return ui
+    if user_id is None:
+        return 'ru'
+    prof = get_user_profile(user_id) or {}
+    ui = prof.get('interface_lang', 'ru')
+    try:
+        ctx.user_data['ui_lang'] = ui
+    except Exception:
+        pass
+    return ui
@@ -23,8 +36,8 @@
-async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
-    ui = _ui_lang(context)
-    user_id = update.effective_user.id
+async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
+    user_id = update.effective_user.id
+    ui = _ui_lang(context, user_id)
@@ -54,6 +67,9 @@
     # –ö–Ω–æ–ø–∫–∞ –ü—Ä–æ–º–æ–∫–æ–¥ –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –±—ã–ª–∞, —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Ñ–æ–ª–ª–±–µ–∫ —è–∑—ã–∫–∞

--- language-bot-main/handlers/settings.py
+++ language-bot-main/handlers/settings.py
@@ -12,7 +12,21 @@
-def _ui_lang(context: ContextTypes.DEFAULT_TYPE) -> str:
-    return (context.user_data or {}).get("ui_lang", "ru")
+from components.profile_db import get_user_profile
+
+def _ui_lang(context: ContextTypes.DEFAULT_TYPE, user_id: int | None = None) -> str:
+    ui = (context.user_data or {}).get('ui_lang') if getattr(context, 'user_data', None) else None
+    if ui:
+        return ui
+    if user_id is None:
+        return 'ru'
+    prof = get_user_profile(user_id) or {}
+    ui = prof.get('interface_lang', 'ru')
+    try:
+        context.user_data['ui_lang'] = ui
+    except Exception:
+        pass
+    return ui
@@ -49,7 +63,7 @@
-    ui = _ui_lang(context)
+    ui = _ui_lang(context, chat_id)
@@ -136,8 +150,8 @@
-    ui = _ui_lang(context)
-    chat_id = q.message.chat.id
+    chat_id = q.message.chat.id
+    ui = _ui_lang(context, chat_id)
@@ -220,6 +234,11 @@
             InlineKeyboardButton("üé® –ü–æ–º–µ–Ω—è—Ç—å —Å—Ç–∏–ª—å" if ui == "ru" else "üé® Change style",
                                  callback_data="SETTINGS:STYLE"),
         ],
+        [
+            InlineKeyboardButton("üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥" if ui == "ru" else "üéüÔ∏è Promo code",
+                                 callback_data="open:promo"),
+        ],
     ])

--- language-bot-main/components/onboarding.py
+++ language-bot-main/components/onboarding.py
@@ -88,7 +88,8 @@
-    session["interface_lang"] = lang_code
+    session["interface_lang"] = lang_code
+    context.user_data['ui_lang'] = lang_code
@@ -145,7 +146,12 @@
-    await query.edit_message_text(text=PROMO_ASK.get(lang_code, PROMO_ASK["en"]))
+    await query.edit_message_text(text=(
+        "–£ —Ç–µ–±—è –µ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?\nüëâ –û—Ç–ø—Ä–∞–≤—å –µ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π: /promo <–∫–æ–¥>\n\n–ù–∞–∂–º–∏ üÜó, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –ø—Ä–æ–º–æ–∫–æ–¥–∞"
+        if lang_code == 'ru' else
+        "Do you have a promo code?\nüëâ Send it with the command: /promo <code>\n\nTap üÜó to continue without a promo code"
+    ), reply_markup=get_ok_keyboard())
@@ -201,7 +207,41 @@
-@safe_handler
-async def promo_code_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
-    chat_id = update.effective_chat.id
-    session = user_sessions.setdefault(chat_id, {})
-    lang_code = session.get("interface_lang", "en")
-    promo_input = (update.message.text or "").strip()
-
-    if promo_input.lower() in ["–Ω–µ—Ç", "no"]:
-        ...  # –°–¢–ê–†–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–ò–ù–ò–ú–ê–õ–ê –ö–û–î –¢–ï–ö–°–¢–û–ú
+@safe_handler
+async def promo_code_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
+    chat_id = update.effective_chat.id
+    session = user_sessions.setdefault(chat_id, {})
+    lang_code = session.get("interface_lang", "en")
+    promo_input = (update.message.text or "").strip()
+
+    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –≤–≤–æ–¥–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
+    if promo_input.lower() in ["–Ω–µ—Ç", "no"]:
+        await context.bot.send_message(
+            chat_id=chat_id,
+            text=START_MESSAGE.get(lang_code, START_MESSAGE["en"]),
+            reply_markup=get_ok_keyboard()
+        )
+        session["onboarding_stage"] = "awaiting_ok"
+        return
+
+    # –ù–∞ —ç—Ç–∞–ø–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –ø—Ä–∏–Ω–∏–º–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥—ã –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /promo <–∫–æ–¥>
+    tip = ("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –∫–æ–º–∞–Ω–¥–æ–π: /promo <–∫–æ–¥>" if lang_code == "ru"
+           else "Send the promo code using the command: /promo <code>")
+    await context.bot.send_message(chat_id=chat_id, text=tip)
+    # –û—Å—Ç–∞—ë–º—Å—è –Ω–∞ —ç—Ç–∞–ø–µ –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ ‚Äî –∂–¥—ë–º /promo –∏–ª–∏ '–Ω–µ—Ç'
+    session["onboarding_stage"] = "awaiting_promo"
+    return
@@ -260,6 +300,7 @@
 # --- –®–ê–ì 4. OK ‚Äî –í—ã–±–æ—Ä —è–∑—ã–∫–∞ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è ---
 @safe_handler
 async def onboarding_ok_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
```
